<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><meta content="dark light"name=color-scheme><meta content=#ffffff name=theme-color media=(prefers-color-scheme:light)><meta content=#000000 name=theme-color media=(prefers-color-scheme:dark)><meta content="Sabrina Jewson"property=og:site_name><link href=/favicon.ico rel=icon><link href=/apple-touch-icon.png rel=apple-touch-icon><link href=/common.css rel=stylesheet><title>Building this site - Sabrina Jewson</title><meta content="Building this site"property=og:title><meta content="Since I’ve spent the past few days working on creating this website, I thought I’d make good use of the effort by documenting my experiences here."name=description><meta content=article property=og:type><link href=post.css rel=stylesheet><link href=feed.xml rel=alternate title="Sabrina Jewson's Blog"type=application/atom+xml></head><body><header><a href=/ class=name>Sabrina Jewson</a><nav><a href=/blog/ >Blog</a></nav></header><main><h1>Building this site</h1><p id=published><time datetime=2022-03-09>2022-03-09</time></p><nav><ul><li><a href=#the-build-system>The build system</a></li><li><a href=#the-markdown-renderer>The Markdown renderer</a></li><li><a href=#templating>Templating</a></li><li><a href=#minification>Minification</a></li><li><a href=#adding-a-dark-theme>Adding a dark theme</a></li><li><a href=#adding-the-favicon>Adding the favicon</a></li><li><a href=#a-live-reloading-dev-server>A live-reloading dev server</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav><p>Since I’ve spent the past few days working on creating this website, I thought I’d make good use of the effort by documenting my experiences here.</p><p>I got the idea to create a website from a desire to have a place to write blog posts. Initially I had plans on just making GitHub gists and sharing them on Reddit or something, but I (thankfully) decided against that since a site allows for much more flexibility.</p><p>To avoid having to maintain a web server myself, I’m just using GitHub Pages to host it (but on a custom domain to make the URL shorter). I also decided against using a static site generator since it’s a lot more fun to build it myself.</p><h2 id=the-build-system><a href=#the-build-system class=anchor></a>The build system</h2><p>I’m not going to write the HTML for this manually, so I needed to decide on a build system to use. I briefly considered existing options like Make, <a href=https://gulpjs.com/ >Gulp</a> or <a href=https://sagiegurari.github.io/cargo-make/ >cargo-make</a> but eventually decided to write my own thing in Rust.</p><p>The requirements I had for it were this:</p><ul><li>Does the minimum amount of work possible between rebuilds.</li><li>Has a “watch mode” that can be enabled with zero extra configuration to watch the directory for changes and automatically rebuild when they happen.</li></ul><p>After some thinking and a few failed attempts, I had devised quite a neat solution: the <code class=scode>Asset</code> trait. The core API is this:</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta strait"><span class="srust stype sstorage strait">trait</span> <span class="srust sentity sname strait">Asset</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust stype stype sstorage">type</span> <span class="srust stype sentity sname">Output</span><span class="srust spunctuation sterminator">;</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">modified</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> Modified</span></span><span class="srust spunctuation sterminator">;</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">generate</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">Self</span><span class="srust spunctuation saccessor">::</span></span></span>Output</span></span><span class="srust spunctuation sterminator">;</span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			
			<span class="srust smeta senum"><span class="srust stype sstorage senum">enum</span> <span class="srust sentity sname senum">Modified</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    Never<span class="srust spunctuation sseparator">,</span>
			    At<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>SystemTime</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sseparator">,</span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span></code></pre><p>Each <code class=scode>Asset</code> represents a resource in the generation process: a text file being read, a JSON file being parsed, an HTML file being generated, an image being tranformed, et cetera. It has two main capabilities: calling <code class=scode>generate</code> to do the (potentially expensive) work to actually produce the value, and calling <code class=scode>modified</code> to cheaply compute the time at which that value was last modified.</p><p>The <code class=scode>Modified</code> enum is mostly just a <code class=scode>SystemTime</code> but also has a special variant <code class=scode>Never</code> to represent a time before all <code class=scode>SystemTime</code>s, which is used for when getting the modification time fails (e.g. a deleted/non-existent file) or when the asset’s value is a constant.</p><p>The three most basic implementors of this trait are <code class=scode>Constant</code>, <code class=scode>Dynamic</code> and <code class=scode>FsPath</code>, representing a constant value, a dynamic but immutable value (typically command-line arguments) and a value sourced from a filesystem path’s modification time respectively. Their implementations are pretty much as you’d expect:</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta sstruct"><span class="srust stype sstorage sstruct">struct</span> </span><span class="srust smeta sstruct"><span class="srust smeta sgeneric"><span class="srust sentity sname sstruct">Constant</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation send sdefinition sgeneric">></span></span></span></span><span class="srust smeta sstruct"></span><span class="srust smeta sstruct"><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>T</span><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			<span class="srust smeta simpl"><span class="srust stype sstorage simpl">impl</span></span><span class="srust smeta simpl"><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation sseparator">:</span> Clone<span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta simpl"> Asset <span class="srust skeyword sother">for</span></span><span class="srust smeta simpl"> <span class="srust simpl sentity sname">Constant</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation send sdefinition sgeneric">></span></span> </span><span class="srust smeta simpl"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust stype stype sstorage">type</span> <span class="srust stype sentity sname">Output</span> <span class="srust skeyword soperator">=</span> T<span class="srust spunctuation sterminator">;</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">modified</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> Modified</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span> <span class="srust smeta spath">Modified<span class="srust spunctuation saccessor">::</span></span>Never </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">generate</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">Self</span><span class="srust spunctuation saccessor">::</span></span></span>Output</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span> <span class="srust svariable slanguage">self</span>.<span class="srust sconstant snumeric sfloat">0.</span><span class="srust sfunction ssupport">clone</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span> </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			
			<span class="srust smeta sstruct"><span class="srust stype sstorage sstruct">struct</span> </span><span class="srust smeta sstruct"><span class="srust smeta sgeneric"><span class="srust sentity sname sstruct">Dynamic</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation send sdefinition sgeneric">></span></span></span></span><span class="srust smeta sstruct"> </span><span class="srust smeta sstruct"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust svariable smember sother">created</span><span class="srust spunctuation sseparator">:</span> SystemTime,
			    <span class="srust svariable smember sother">value</span><span class="srust spunctuation sseparator">:</span> T,
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			<span class="srust smeta simpl"><span class="srust stype sstorage simpl">impl</span></span><span class="srust smeta simpl"><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta simpl"> <span class="srust simpl sentity sname">Dynamic</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation send sdefinition sgeneric">></span></span> </span><span class="srust smeta simpl"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">new</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust svariable sparameter">value</span><span class="srust spunctuation sseparator">:</span> T</span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust stype sstorage">Self</span></span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
					<span class="srust stype sstorage">let</span> created <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">SystemTime<span class="srust spunctuation saccessor">::</span></span>now<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			        <span class="srust stype sstorage">Self</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span> created<span class="srust spunctuation sseparator">,</span> value </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
			    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			<span class="srust smeta simpl"><span class="srust stype sstorage simpl">impl</span></span><span class="srust smeta simpl"><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation sseparator">:</span> Clone<span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta simpl"> Asset <span class="srust skeyword sother">for</span></span><span class="srust smeta simpl"> <span class="srust simpl sentity sname">Dynamic</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>T<span class="srust spunctuation send sdefinition sgeneric">></span></span> </span><span class="srust smeta simpl"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust stype stype sstorage">type</span> <span class="srust stype sentity sname">Output</span> <span class="srust skeyword soperator">=</span> T<span class="srust spunctuation sterminator">;</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">modified</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> Modified</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span> <span class="srust smeta spath">Modified<span class="srust spunctuation saccessor">::</span></span>At<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust svariable slanguage">self</span>.created</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span> </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">generate</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">Self</span><span class="srust spunctuation saccessor">::</span></span></span>Output</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span> <span class="srust svariable slanguage">self</span>.value.<span class="srust sfunction ssupport">clone</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span> </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			
			<span class="srust smeta sstruct"><span class="srust stype sstorage sstruct">struct</span> </span><span class="srust smeta sstruct"><span class="srust smeta sgeneric"><span class="srust sentity sname sstruct">FsPath</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>P<span class="srust spunctuation send sdefinition sgeneric">></span></span></span></span><span class="srust smeta sstruct"></span><span class="srust smeta sstruct"><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>P</span><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			<span class="srust smeta simpl"><span class="srust stype sstorage simpl">impl</span></span><span class="srust smeta simpl"><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>P<span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">AsRef<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Path<span class="srust spunctuation send sdefinition sgeneric">></span></span><span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta simpl"> Asset <span class="srust skeyword sother">for</span></span><span class="srust smeta simpl"> <span class="srust simpl sentity sname">FsPath</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>P<span class="srust spunctuation send sdefinition sgeneric">></span></span> </span><span class="srust smeta simpl"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust stype stype sstorage">type</span> <span class="srust stype sentity sname">Output</span> <span class="srust skeyword soperator">=</span> <span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">modified</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> Modified</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
					<span class="srust smeta spath">fs<span class="srust spunctuation saccessor">::</span></span>symlink_metadata<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable slanguage">self</span>.<span class="srust sconstant snumeric sdecimal sinteger">0</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			            .<span class="srust sfunction ssupport">and_then</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust svariable sparameter">metadata</span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure">metadata.<span class="srust sfunction ssupport">modified</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			            .<span class="srust sfunction ssupport">map_or</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta spath">Modified<span class="srust spunctuation saccessor">::</span></span>Never<span class="srust spunctuation sseparator">,</span> <span class="srust smeta spath">Modified<span class="srust spunctuation saccessor">::</span></span>At</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">generate</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">Self</span><span class="srust spunctuation saccessor">::</span></span></span>Output</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span></span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span></code></pre><p><code class=scode>FsPath</code> is intentionally agnostic over how the actual path is read, allowing you to many different functions depending on the actual nature of the path (whether it’s a binary file, text file, JSON file, directory, et cetera).</p><p>With these base types there are then many combinators you can apply. One basic one is <code class=scode>all</code>, which combines multiple <code class=scode>Asset</code>s into one for when a resulting asset is generated from more than one input file (such as this HTML file, which is generated from the source markdown and a template). It works on all kinds of containers of multiple assets including tuples and vectors. Example usage looks like:</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta spath">asset<span class="srust spunctuation saccessor">::</span></span>all<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>foo_asset<span class="srust spunctuation sseparator">,</span> bar_asset</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
				.<span class="srust sfunction ssupport">map</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust svariable sparameter">foo_value</span><span class="srust spunctuation sseparator">,</span> <span class="srust svariable sparameter">bar_value</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust sblock scomment"><span class="srust spunctuation sdefinition scomment">/*</span> use both `foo_value` and `bar_value` <span class="srust spunctuation sdefinition scomment">*/</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			</span></code></pre><p>Its <code class=scode>modified</code> implementation takes the latest modification time of all the inner assets, and its <code class=scode>generate</code> implementation just forwards to the generation code of each one then packages them all up together in a tuple. However, you might notice a problem here: with the code above, if <code class=scode>bar</code> is changed but <code class=scode>foo</code> isn’t then both <code class=scode>foo</code> <em>and</em> <code class=scode>bar</code> are regenerated even if only <code class=scode>bar</code> actually needs to be.</p><p>This is where another combinator comes in: <code class=scode>Cache</code>. It provides an in-memory cache of the output’s value (as long as it is <code class=scode>Clone</code>), allowing cases like the above to simply use the cached value of <code class=scode>foo</code> instead of regenerating it from scratch.</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta sstruct"><span class="srust stype sstorage sstruct">struct</span> </span><span class="srust smeta sstruct"><span class="srust smeta sgeneric"><span class="srust sentity sname sstruct">Cache</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>A<span class="srust spunctuation sseparator">:</span> Asset<span class="srust spunctuation send sdefinition sgeneric">></span></span></span></span><span class="srust smeta sstruct"> </span><span class="srust smeta sstruct"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust svariable smember sother">asset</span><span class="srust spunctuation sseparator">:</span> A,
			    <span class="srust svariable smember sother">cached</span><span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">Cell<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span><span class="srust smeta sgeneric">Option<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span><span class="srust spunctuation ssection sgroup sbegin">(</span>Modified, <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">A</span><span class="srust spunctuation saccessor">::</span></span></span>Output<span class="srust spunctuation ssection sgroup send">)</span><span class="srust spunctuation send sdefinition sgeneric">></span></span><span class="srust spunctuation send sdefinition sgeneric">></span></span>,
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			<span class="srust smeta simpl"><span class="srust stype sstorage simpl">impl</span></span><span class="srust smeta simpl"><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>A<span class="srust spunctuation sseparator">:</span> Asset<span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta simpl"> Asset <span class="srust skeyword sother">for</span></span><span class="srust smeta simpl"> <span class="srust simpl sentity sname">Cache</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>A<span class="srust spunctuation send sdefinition sgeneric">></span></span>
			</span><span class="srust smeta simpl"><span class="srust skeyword sother">where</span>
			    <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">A</span><span class="srust spunctuation saccessor">::</span></span></span>Output<span class="srust spunctuation sseparator">:</span> Clone,
			</span><span class="srust smeta simpl"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust stype stype sstorage">type</span> <span class="srust stype sentity sname">Output</span> <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">A<span class="srust spunctuation saccessor">::</span></span>Output<span class="srust spunctuation sterminator">;</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">modified</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> Modified</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			        <span class="srust svariable slanguage">self</span>.asset.<span class="srust sfunction ssupport">modified</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">generate</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">Self</span><span class="srust spunctuation saccessor">::</span></span></span>Output</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			        <span class="srust stype sstorage">let</span> inner_modified <span class="srust skeyword soperator">=</span> <span class="srust svariable slanguage">self</span>.asset.<span class="srust sfunction ssupport">modified</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			        <span class="srust stype sstorage">let</span> <span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>last_modified<span class="srust spunctuation sseparator">,</span> output</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">=</span> <span class="srust svariable slanguage">self</span>
			            .cached
			            .<span class="srust sfunction ssupport">take</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			            .<span class="srust sfunction ssupport">filter</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust skeyword soperator">&</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust svariable sparameter">last_modified</span><span class="srust spunctuation sseparator">,</span> _</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure">last_modified <span class="srust skeyword soperator">></span><span class="srust skeyword soperator">=</span> inner_modified</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			            .<span class="srust sfunction ssupport">unwrap_or_else</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>inner_modified<span class="srust spunctuation sseparator">,</span> <span class="srust svariable slanguage">self</span>.asset.<span class="srust sfunction ssupport">generate</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			        <span class="srust svariable slanguage">self</span>.cached.<span class="srust sfunction ssupport">set</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust stype ssupport">Some</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>last_modified<span class="srust spunctuation sseparator">,</span> output.<span class="srust sfunction ssupport">clone</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			        output
			    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span></code></pre><p>In the code snippet above, the <code class=scode>generate</code> function of <code class=scode>Cache</code> will first attempt to use the cached value instead of regenerating the asset if the inner asset hasn’t been modified since the cache was taken.</p><p>Another place where <code class=scode>Cache</code> is useful is when an asset is shared between multiple output assets (like how my “blog post template” asset is shared with every blog post), and <code class=scode>Cache</code> can be applied to avoid regenerating the shared asset every time.</p><p>The last combinator I will talk about here is called <code class=scode>ModifiesPath</code>, and it is perhaps the most important one. You can apply it to an asset that as a side-effect makes changes to a path on the filesystem, and it allows that asset to avoid rerunning itself when the asset’s age is older than the path it modifies.</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta sstruct"><span class="srust stype sstorage sstruct">struct</span> </span><span class="srust smeta sstruct"><span class="srust smeta sgeneric"><span class="srust sentity sname sstruct">ModifiesPath</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>A, P<span class="srust spunctuation send sdefinition sgeneric">></span></span></span></span><span class="srust smeta sstruct"> </span><span class="srust smeta sstruct"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust svariable smember sother">asset</span><span class="srust spunctuation sseparator">:</span> A,
			    <span class="srust svariable smember sother">path</span><span class="srust spunctuation sseparator">:</span> P,
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			<span class="srust smeta simpl"><span class="srust stype sstorage simpl">impl</span></span><span class="srust smeta simpl"><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>A<span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">Asset<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Output = <span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust spunctuation ssection sgroup send">)</span><span class="srust spunctuation send sdefinition sgeneric">></span></span>, P<span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">AsRef<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Path<span class="srust spunctuation send sdefinition sgeneric">></span></span><span class="srust spunctuation send sdefinition sgeneric">></span></span></span><span class="srust smeta simpl"> Asset <span class="srust skeyword sother">for</span></span><span class="srust smeta simpl"> <span class="srust simpl sentity sname">ModifiesPath</span><span class="srust smeta sgeneric"><span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>A, P<span class="srust spunctuation send sdefinition sgeneric">></span></span> </span><span class="srust smeta simpl"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust stype stype sstorage">type</span> <span class="srust stype sentity sname">Output</span> <span class="srust skeyword soperator">=</span> <span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">modified</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> Modified</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
					<span class="srust smeta spath">fs<span class="srust spunctuation saccessor">::</span></span>symlink_metadata<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable slanguage">self</span>.path</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			            .<span class="srust sfunction ssupport">and_then</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust svariable sparameter">metadata</span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure">metadata.<span class="srust sfunction ssupport">modified</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			            .<span class="srust sfunction ssupport">map_or</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta spath">Modified<span class="srust spunctuation saccessor">::</span></span>Never<span class="srust spunctuation sseparator">,</span> <span class="srust smeta spath">Modified<span class="srust spunctuation saccessor">::</span></span>At</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			    <span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">generate</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span><span class="srust skeyword soperator">&</span><span class="srust svariable sparameter">self</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> <span class="srust smeta spath"><span class="srust stype sstorage"><span class="srust stype sstorage">Self</span><span class="srust spunctuation saccessor">::</span></span></span>Output</span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			        <span class="srust stype sstorage">let</span> output_modified <span class="srust skeyword soperator">=</span> <span class="srust svariable slanguage">self</span>.<span class="srust sfunction ssupport">modified</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			        <span class="srust skeyword scontrol">if</span> <span class="srust svariable slanguage">self</span>.asset.<span class="srust sfunction ssupport">modified</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">></span><span class="srust skeyword soperator">=</span> output_modified
						<span class="srust skeyword soperator">|</span><span class="srust skeyword soperator">|</span> <span class="srust skeyword soperator">*</span><span class="srust sother sconstant">EXE_MODIFIED</span> <span class="srust skeyword soperator">></span><span class="srust skeyword soperator">=</span> output_modified
					<span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			            <span class="srust svariable slanguage">self</span>.asset.<span class="srust sfunction ssupport">generate</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			        </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
			    </span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			
			<span class="srust stype sstorage">static</span> <span class="srust sother sconstant">EXE_MODIFIED</span><span class="srust spunctuation sseparator">:</span> <span class="srust smeta sgeneric">Lazy<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Modified<span class="srust spunctuation send sdefinition sgeneric">></span></span> <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">Lazy<span class="srust spunctuation saccessor">::</span></span>new<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust stype sstorage">let</span> time <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">env<span class="srust spunctuation saccessor">::</span></span>current_exe<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
					.<span class="srust sfunction ssupport">and_then</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta spath">fs<span class="srust spunctuation saccessor">::</span></span>symlink_metadata</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
					.<span class="srust sfunction ssupport">and_then</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust svariable sparameter">metadata</span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure">metadata.<span class="srust sfunction ssupport">modified</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
					.<span class="srust sfunction ssupport">unwrap_or_else</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters">_<span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust smeta spath">SystemTime<span class="srust spunctuation saccessor">::</span></span>now<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
				<span class="srust smeta spath">Modified<span class="srust spunctuation saccessor">::</span></span>At<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>time</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			</span></code></pre><p>It is this combinator that allows the Make-like behaviour of comparing ages of input and output files and only rebuilding when necessary.</p><p>The other thing <code class=scode>ModifiesPath</code> does is takes into account the age of the executable it is running in, forcing a rebuild if the executable itself has been changed since the output was last generated. This is very useful during development to avoid situations where you need to manually remove the destination directory to force assets to be rebuilt.</p><p>The combination of all these features forms a very powerful build system implemented in simple Rust code. For example, suppose I wanted to make a build script that copies over <code class=scode>source.txt</code> to <code class=scode>destination.txt</code>. That would look like this:</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">main</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
				<span class="srust stype sstorage">let</span> asset <span class="srust skeyword soperator">=</span> <span class="srust sfunction ssupport">source_to_dest</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
				asset.<span class="srust sfunction ssupport">generate</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			
			<span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">source_to_dest</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> impl <span class="srust smeta sgeneric">Asset<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Output = <span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust spunctuation ssection sgroup send">)</span><span class="srust spunctuation send sdefinition sgeneric">></span></span></span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
				<span class="srust smeta spath">asset<span class="srust spunctuation saccessor">::</span></span><span class="srust smeta spath">FsPath<span class="srust spunctuation saccessor">::</span></span>new<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>source.txt<span class="srust spunctuation send sdefinition sstring">"</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
					.<span class="srust sfunction ssupport">map</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
						<span class="srust stype sstorage">let</span> res <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">fs<span class="srust spunctuation saccessor">::</span></span>copy<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>source.txt<span class="srust spunctuation send sdefinition sstring">"</span></span><span class="srust spunctuation sseparator">,</span> <span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>destination.txt<span class="srust spunctuation send sdefinition sstring">"</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
						<span class="srust skeyword scontrol">if</span> <span class="srust stype sstorage">let</span> <span class="srust stype ssupport">Err</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>e</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">=</span> res <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
							<span class="srust smeta spath">log<span class="srust spunctuation saccessor">::</span></span>error<span class="srust skeyword soperator">!</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>error copying files: {e}<span class="srust spunctuation send sdefinition sstring">"</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
						</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
					</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
					.<span class="srust sfunction ssupport">modifies_path</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>destination.txt<span class="srust spunctuation send sdefinition sstring">"</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span></code></pre><p>And just like that, we have automatic tracking of dependencies done for free. Now suppose I wanted to add a “watch” mode that waits for changes to <code class=scode>source.txt</code> to happen and copies it over again. Absolutely no changes to the <code class=scode>source_to_dest</code> function are needed, all we have to do is layer some code using <a href=https://github.com/notify-rs/notify><code class=scode>notify</code></a> on top of that:</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">main</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
				<span class="srust stype sstorage">let</span> asset <span class="srust skeyword soperator">=</span> <span class="srust sfunction ssupport">source_to_dest</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
				asset.<span class="srust sfunction ssupport">generate</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			
				<span class="srust stype sstorage">let</span> <span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>events_sender<span class="srust spunctuation sseparator">,</span> events</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span> <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">crossbeam_channel<span class="srust spunctuation saccessor">::</span></span>bounded<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sconstant snumeric sdecimal sinteger">16</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			
				<span class="srust stype sstorage">let</span> <span class="srust smodifier sstorage">mut</span> watcher <span class="srust skeyword soperator">=</span> <span class="srust smeta spath">notify<span class="srust spunctuation saccessor">::</span></span>recommended_watcher<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span>events_sender</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
				watcher.<span class="srust sfunction ssupport">watch</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>.<span class="srust spunctuation send sdefinition sstring">"</span></span>.<span class="srust sfunction ssupport">as_ref</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sseparator">,</span> <span class="srust smeta spath">notify<span class="srust spunctuation saccessor">::</span></span><span class="srust smeta spath">RecursiveMode<span class="srust spunctuation saccessor">::</span></span>Recursive</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">unwrap</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
			
				<span class="srust skeyword scontrol">loop</span> <span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
					<span class="srust stype sstorage">let</span> <span class="srust skeyword soperator">_</span> <span class="srust skeyword soperator">=</span> events.<span class="srust sfunction ssupport">recv</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">unwrap</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>.<span class="srust sfunction ssupport">unwrap</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
					asset.<span class="srust sfunction ssupport">generate</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation sterminator">;</span>
				</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span></code></pre><p>And there we are, everything is handled automatically from that point onward. Due to the in-memory caching and on-disk comparison that assets usually perform it ends up being pretty efficient, doing close to the minimum amount of work necessary between rebuilds. It could theoretically be improved if the <em>contents</em> of the <code class=scode>notify::Event</code>s were actually paid attention to instead of having to repeatedly call <code class=scode>fs::symlink_metadata</code> a bunch, but I haven’t had a need to implement that just yet.</p><p>So there it is, a powerful and flexible build system implemented and configured from just Rust code. I haven’t bothered to release it as a crate at all - if someone asks me to I might but I don’t know if it would be useful to anyone else, or if something like this already exists in the ecosystem. But I’m sharing it because I think it’s quite a neat solution to this particular problem.</p><h2 id=the-markdown-renderer><a href=#the-markdown-renderer class=anchor></a>The Markdown renderer</h2><p>The heart of this ad-hoc site generator is really the Markdown renderer. It’s what converts the Markdown files that I write the posts in into the HTML being rendered right now by your web browser. So it’s fitting for us to start there.</p><p>A markdown renderer consists of two main parts: the first stage that parses the source strings into a more code-friendly format, and the second stage that generates the HTML from the abstract Rust representation produced by the parser.</p><p>I don’t enjoy writing parsers, so I decided to shell out to an external crate for that. I chose <a href=https://docs.rs/pulldown_cmark><code class=scode>pulldown_cmark</code></a> because it is widely used, has a flexible API and supports a bunch of features that I really like (CommonMark + tables + smart quotes + heading IDs).</p><p>While <code class=scode>pulldown_cmark</code> does come with its own HTML generator and I could’ve just used that and called it a day, there are a bunch of features and additions I would like to implement that would be far easier if I could control generation myself rather than trying to modify the HTML AST after-the-fact.</p><p>So, taking inspiration from <code class=scode>pulldown_cmark</code>’s HTML renderer, I resolved to write my own. It works by walking once through all the events emitted by <code class=scode>pulldown_cmark</code>’s <code class=scode>Parser</code> struct and keeping track of state along the way in a gigantic <code class=scode>Renderer</code> type. Once the tree walk is finished, it runs a bit of finalization before dumping its relevant fields in the resulting <code class=scode>Markdown</code> struct:</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta sstruct"><span class="srust stype sstorage sstruct">struct</span> </span><span class="srust smeta sstruct"><span class="srust sentity sname sstruct">Markdown</span> </span><span class="srust smeta sstruct"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust svariable smember sother">title</span><span class="srust spunctuation sseparator">:</span> String,
			    <span class="srust svariable smember sother">body</span><span class="srust spunctuation sseparator">:</span> String,
			    <span class="srust svariable smember sother">summary</span><span class="srust spunctuation sseparator">:</span> String,
			    <span class="srust svariable smember sother">outline</span><span class="srust spunctuation sseparator">:</span> String,
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span></code></pre><p>Looking at these fields, you can probably tell why I didn’t just use the default HTML generator - there’s a lot of custom functionality in there not provided by plain <code class=scode>pulldown_cmark</code>. <code class=scode>title</code> contains the title of the page, <code class=scode>body</code> contains the body HTML (but excluding the title), <code class=scode>summary</code> contains the un-HTML-ified first paragraph of the content (this is used to put in each page’s <code class=scode><span class="shtml sbasic stext"><span class="smeta shtml stag sany sinline"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sinline sentity sname">meta</span> <span class="smeta shtml sattribute-with-value"><span class="shtml sentity sattribute-name sother">name</span><span class="spunctuation sseparator skey-value shtml">=</span></span><span class="smeta shtml sattribute-with-value"><span class="shtml sstring sdouble squoted"><span class="spunctuation sbegin sdefinition shtml sstring">"</span>description<span class="spunctuation send sdefinition shtml sstring">"</span></span></span><span class="spunctuation send sdefinition shtml stag">></span></span></span></code> tags) and <code class=scode>outline</code> is the automatically generated table of contents you can see at the top of this page.</p><p>Another reason I wanted to write my own HTML renderer is to enable syntax highlighting - by default <code class=scode>pulldown_cmark</code> puts all code into plain <code class=scode><span class="shtml sbasic stext"><span class="smeta sblock sany shtml stag"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sentity sname sblock">pre</span><span class="spunctuation send sdefinition shtml stag">></span></span></span></code> and <code class=scode><span class="shtml sbasic stext"><span class="smeta shtml stag sany sinline"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sinline sentity sname">code</span><span class="spunctuation send sdefinition shtml stag">></span></span></span></code> elements, but I wanted to transform it with build-time syntax highlighting instead to enable the pretty colours you can see in the code I write.</p><p>I chose the <a href=https://github.com/trishume/syntect><code class=scode>syntect</code></a> crate to do the highlighting, since it’s widely used and has the features I need. It turned out to be pretty simple to add this functionality; I just embed the syntax definitions in the source code and load it in a lazy static, then use a <a href=https://docs.rs/syntect/4/syntect/html/struct.ClassedHTMLGenerator.html><code class=scode>ClassedHTMLGenerator</code></a> to produce the actual HTML. The themes can be loaded separately by loading them at runtime in an <code class=scode>Asset</code>, converting them to CSS then concatenating with the CSS file for blog posts.</p><p>And that’s pretty much all there is to it: a single pure function that goes from markdown source to rendered HTML, to be later inserted into whichever document needs it. Actually, speaking of inserting it into documents, how <em>does</em> that work?</p><h2 id=templating><a href=#templating class=anchor></a>Templating</h2><p>Unfortunately it’s not enough to just take rendered HTML, stick it in a <code class=scode>.html</code> file and call it a day. I need to add an HTML skeleton around it to add the document title, <a href=#adding-the-favicon>favicon</a>, metadata and sitewide navigation links you can see on this page.</p><p>Initially, I had written <a href=https://github.com/SabrinaJewson/sabrinajewson.github.io/blob/2df2918523de279720a5854b658864c92fe0671a/builder/src/util/template.rs>my own custom templater</a> for this. It was barely even a templater really, being so ridiculously minimal: just ~100 lines of code that replaced <code class=scode>\{variable_name}</code> with its contents. But as the project continued to grow I realized that I needed a better solution than that, so I decided to switch to a full-fledged templating library.</p><p>I chose <a href=https://docs.rs/handlebars><code class=scode>handlebars</code></a> for this, not for any particular reason, but I wanted to try it out since I’ve only used Tera before. I used my <code class=scode>Asset</code> system to create an asset that loads all the common “fragment” templates from an <code class=scode>include/</code> directory as well as individual <code class=scode>Asset</code>s for each template per page, then I combined them together and rendered it all to produce the final pages.</p><p>The template system turned out to be pretty powerful and definitely worth the extra dependency. I’m able to automatically generate pretty much everything automatically, like my <a href=.>list of blog posts</a> whose content is sourced from the Markdown files only. Additionally, all the HTML boilerplate used repeatedly in every page can be abstracted to <a href=https://github.com/SabrinaJewson/sabrinajewson.github.io/blob/fa55487a0d9bd3ee46d68fa51ea32d9a2eaa2772/template/include/base.hbs>a common file</a> which turned out to be very useful for code reuse.</p><h2 id=minification><a href=#minification class=anchor></a>Minification</h2><p>To reduce page load times, I decided to minify all my HTML and CSS before writing each asset to its final file. I know that there exist minifiers for this in native Rust, but realistically all the state-of-the-art ones are in JavaScript. I ended up choosing <a href=https://github.com/terser/html-minifier-terser>html-minifier-terser</a> and <a href=https://clean-css.github.io/ >clean-css</a> for this, which both seem to be well-maintained and have small output sizes.</p><p>Initially I planned on achieving maximum efficiency by using both projects as a library and starting up a single long-running Node process that I communicate with via IPC, to avoid the inefficiencies of starting up a whole new Node instance each time I wanted to minify something. But that plan ended up falling apart rather quickly, since I totally lack experience with Node and just couldn’t figure out how to get it to work. Maybe it’s just me but Node’s <a href=https://nodejs.org/api/stream.html#readable-streams>readable stream</a> interface seems a million times more complicated and hard to use than Rust’s <code class=scode>AsyncRead</code> - it has four (!) separate ways of using the API of which none are as simple as just <code class=scode>read_exact</code>. And it doesn’t help that I despise writing JavaScript altogether - TypeScript makes it somewhat better but in comparison to Rust it’s just painful.</p><p>So with that plan scrapped, it was just a matter of calling into their CLIs each time (which luckily both libraries have). To avoid global dependencies I created a local npm package that uses both packages as a dependency. Then I could simply have a <code class=scode>std::process::Command</code> run <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="svariable sfunction sshell">npx</span></span><span class="smeta sfunction-call sshell sarguments"> html-minifier-terser</span></span></code> or <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="svariable sfunction sshell">npx</span></span><span class="smeta sfunction-call sshell sarguments"> cleancss</span></span></code> in that package’s directory and pipe through my files to have them minified.</p><p>The one issue I encountered is that unlike Cargo, npm doesn’t automatically install required dependencies before trying to run code. This means that in order to successfully build my website from a freshly cloned repository, you would’ve had to manually <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="sshell sfunction scd ssupport">cd</span></span></span></code> to the package directory and run <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="svariable sfunction sshell">npm</span></span><span class="smeta sfunction-call sshell sarguments"> install</span></span></code> beforehand - obviously not ideal.</p><p>My first solution to this was just to run that command first thing whenever the building binary starts up. But since <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="svariable sfunction sshell">npm</span></span><span class="smeta sfunction-call sshell sarguments"> install</span></span></code> is slow, it ends up slowing down the whole building process quite a significant amount since I have to wait for it each time. What I really needed was a way to only run the command when it hasn’t been run yet, or when the <code class=scode>package.json</code> changes. Lucky, my whole <code class=scode>Asset</code> system is just perfect for that - I could simply define an asset that runs <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="svariable sfunction sshell">npm</span></span><span class="smeta sfunction-call sshell sarguments"> install</span></span></code> with <code class=scode>package.json</code> specified as its input file and <code class=scode>package-lock.json</code> as the output one (since <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="svariable sfunction sshell">npm</span></span><span class="smeta sfunction-call sshell sarguments"> install</span></span></code> always updates its modification date). It ended up just being a couple lines of code:</p><pre class=scode><code><span class="srust ssource"><span class="srust smeta sfunction"><span class="srust smeta sfunction"><span class="srust sfunction sstorage stype">fn</span> </span><span class="srust sfunction sentity sname">asset</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">(</span></span><span class="srust smeta sfunction"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection send sparameters">)</span></span></span></span><span class="srust smeta sfunction"> <span class="srust smeta sfunction sreturn-type"><span class="srust spunctuation sseparator">-></span> impl <span class="srust smeta sgeneric">Asset<span class="srust spunctuation sbegin sdefinition sgeneric">&lt;</span>Output = <span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust spunctuation ssection sgroup send">)</span><span class="srust spunctuation send sdefinition sgeneric">></span></span></span> </span><span class="srust smeta sfunction"><span class="srust smeta sblock"><span class="srust spunctuation ssection sbegin sblock">{</span>
			    <span class="srust smeta spath">asset<span class="srust spunctuation saccessor">::</span></span><span class="srust smeta spath">FsPath<span class="srust spunctuation saccessor">::</span></span>new<span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>./builder/js/package.json<span class="srust spunctuation send sdefinition sstring">"</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			        .<span class="srust sfunction ssupport">map</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust spunctuation ssection sbegin sparameters">|</span></span></span><span class="srust smeta sfunction sclosure"><span class="srust smeta sfunction sparameters"><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span><span class="srust spunctuation ssection send sparameters">|</span></span> </span><span class="srust smeta sfunction sclosure"><span class="srust sfunction ssupport">log_errors</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sfunction ssupport">npm_install</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			        .<span class="srust sfunction ssupport">modifies_path</span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup sbegin">(</span><span class="srust sstring sdouble squoted"><span class="srust spunctuation sbegin sdefinition sstring">"</span>./builder/js/package-lock.json<span class="srust spunctuation send sdefinition sstring">"</span></span></span><span class="srust smeta sgroup"><span class="srust spunctuation ssection sgroup send">)</span></span>
			</span><span class="srust smeta sblock"><span class="srust spunctuation ssection send sblock">}</span></span></span>
			</span></code></pre><p>And now I have the best of both worlds: fast building as well as automatic package setup.</p><h2 id=adding-a-dark-theme><a href=#adding-a-dark-theme class=anchor></a>Adding a dark theme</h2><p>One specific goal I had for this site was to allow it to work in both light and dark modes, depending on the user’s chosen <code class=scode>prefers-color-scheme</code> setting. I was mildly dreading having to write out two large stylesheets with a different colour palette for each mode, but as it turns out modern browsers have a built-in way to change the default color scheme based on the user’s current <code class=scode>prefers-color-scheme</code> value. All I had to do was add one <code class=scode><span class="shtml sbasic stext"><span class="smeta shtml stag sany sinline"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sinline sentity sname">meta</span><span class="spunctuation send sdefinition shtml stag">></span></span></span></code> to my <code class=scode><span class="shtml sbasic stext"><span class="smeta shtml stag sany sstructure"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sentity sname sstructure">head</span><span class="spunctuation send sdefinition shtml stag">></span></span></span></code>:</p><pre class=scode><code><span class="shtml sbasic stext"><span class="smeta shtml stag sany sinline"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sinline sentity sname">meta</span> <span class="smeta shtml sattribute-with-value"><span class="shtml sentity sattribute-name sother">name</span><span class="spunctuation sseparator skey-value shtml">=</span></span><span class="smeta shtml sattribute-with-value"><span class="shtml sstring sdouble squoted"><span class="spunctuation sbegin sdefinition shtml sstring">"</span>color-scheme<span class="spunctuation send sdefinition shtml sstring">"</span></span></span> <span class="smeta shtml sattribute-with-value"><span class="shtml sentity sattribute-name sother">content</span><span class="spunctuation sseparator skey-value shtml">=</span></span><span class="smeta shtml sattribute-with-value"><span class="shtml sstring sdouble squoted"><span class="spunctuation sbegin sdefinition shtml sstring">"</span>dark light<span class="spunctuation send sdefinition shtml sstring">"</span></span></span><span class="spunctuation send sdefinition shtml stag">></span></span>
			</span></code></pre><p>And everything magically worked first try - if <code class=scode>prefers-color-scheme</code> was <code class=scode>dark</code>, the page would show a black background with consistently white text and if it was <code class=scode>light</code> it would show a white background with consistently black text. You can try it out now - if you open developer tools and press ctrl+shift+p, you should be able to enable the “emulate CSS prefers-color-scheme: dark/light” option and see how the website changes. And all that’s done entirely by the browser’s default styles. Who knew it was so easy?</p><p>The only time I did have to mess with <code class=scode>prefers-color-scheme</code> media queries was for the code blocks. That was easy though, I just wrote out the dark theme CSS then wrapped the light version in <code class=scode><span class="ssource scss"><span class="smeta sat-rule scss smedia"><span class="skeyword scontrol sat-rule scss smedia"><span class="spunctuation sdefinition scss skeyword">@</span>media</span> <span class="spunctuation sbegin sgroup scss sdefinition">(</span>prefers-<span class="stype ssupport scss smedia sproperty-name">color</span>-scheme<span class="spunctuation sseparator skey-value scss">:</span> light<span class="spunctuation send sgroup scss sdefinition">)</span> </span><span class="spunctuation ssection scss sproperty-list">{</span></span></code>.</p><h2 id=adding-the-favicon><a href=#adding-the-favicon class=anchor></a>Adding the favicon</h2><p>The favicon of this site is automatically generated by the build script from a single <code class=scode>.png</code> file in source control. I use the <a href=https://docs.rs/image><code class=scode>image</code></a> crate to read in this source image, then resize it to generate two files:</p><ul><li><code class=scode>favicon.ico</code>, which contains 16x16, 32x32 and 64x64 versions of the icon all packed into a single <code class=scode>.ico</code> file.</li><li><code class=scode>apple-touch-icon.png</code>, which has been resized to 180x180 as is suitable for an apple touch icon.</li></ul><p>The paths of these files are then passed in to the templates, which include them in <code class=scode><span class="shtml sbasic stext"><span class="smeta shtml stag sany sinline"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sinline sentity sname">link</span><span class="spunctuation send sdefinition shtml stag">></span></span></span></code> tags in the head:</p><pre class=scode><code><span class="shtml sbasic stext"><span class="smeta shtml stag sany sinline"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sinline sentity sname">link</span> <span class="smeta shtml sattribute-with-value"><span class="shtml sentity sattribute-name sother">rel</span><span class="spunctuation sseparator skey-value shtml">=</span></span><span class="smeta shtml sattribute-with-value"><span class="shtml sstring sdouble squoted"><span class="spunctuation sbegin sdefinition shtml sstring">"</span>icon<span class="spunctuation send sdefinition shtml sstring">"</span></span></span> <span class="smeta shtml sattribute-with-value"><span class="shtml sentity sattribute-name sother">href</span><span class="spunctuation sseparator skey-value shtml">=</span></span><span class="smeta shtml sattribute-with-value"><span class="shtml sstring sdouble squoted"><span class="spunctuation sbegin sdefinition shtml sstring">"</span>/{{icons.favicon}}<span class="spunctuation send sdefinition shtml sstring">"</span></span></span><span class="spunctuation send sdefinition shtml stag">></span></span>
			<span class="smeta shtml stag sany sinline"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sany sinline sentity sname">link</span> <span class="smeta shtml sattribute-with-value"><span class="shtml sentity sattribute-name sother">rel</span><span class="spunctuation sseparator skey-value shtml">=</span></span><span class="smeta shtml sattribute-with-value"><span class="shtml sstring sdouble squoted"><span class="spunctuation sbegin sdefinition shtml sstring">"</span>apple-touch-icon<span class="spunctuation send sdefinition shtml sstring">"</span></span></span> <span class="smeta shtml sattribute-with-value"><span class="shtml sentity sattribute-name sother">href</span><span class="spunctuation sseparator skey-value shtml">=</span></span><span class="smeta shtml sattribute-with-value"><span class="shtml sstring sdouble squoted"><span class="spunctuation sbegin sdefinition shtml sstring">"</span>/{{icons.apple_touch_icon}}<span class="spunctuation send sdefinition shtml sstring">"</span></span></span><span class="spunctuation send sdefinition shtml stag">></span></span>
			</span></code></pre><p>I’m especially proud of this part of the code because the entire thing is implemented in &lt;100 lines of logic and is far, far more convenient than manually using a site like <a href=https://realfavicongenerator.net/ >RealFaviconGenerator</a> to generate each of the files. The only downside of it is that <a href=https://docs.rs/image><code class=scode>image</code></a> is ridiculously slow in debug mode, so I end up running the build process in <code class=scode>--release</code> all the time 😄.</p><h2 id=a-live-reloading-dev-server><a href=#a-live-reloading-dev-server class=anchor></a>A live-reloading dev server</h2><p>For a long time I was previewing the website by just opening the file in the browser as a <code class=scode>file://</code> URL. But this had several disadvantages:</p><ol><li>Paths like <code class=scode>/favicon.ico</code> would be resolved relative to the filesystem root, rather than the website root.</li><li><code class=scode>index.html</code> wasn’t automatically added to the end of paths if they pointed to directories and that file existed. I’d instead see a screen showing a file listing of the directory and have to click <code class=scode>index.html</code> manually each time.</li><li><code class=scode>.html</code> wasn’t automatically added to the end of paths like <code class=scode>/blog/foo</code>, making my links broken.</li><li>404 links did not show my custom <code class=scode>404.html</code> page.</li><li>I didn’t get live reloading.</li></ol><p>At some point I switched to <code class=scode><span class="sshell sbash ssource"><span class="smeta sfunction-call sshell"><span class="svariable sfunction sshell">python</span></span><span class="smeta sfunction-call sshell sarguments"><span class="svariable sparameter soption sshell"><span class="spunctuation sdefinition sparameter sshell"> -</span>m</span> http.server</span></span></code> and that solved issues (1) and (2) but not the others. So eventually I’d had enough and decided to write my own server with all these features, in Rust.</p><p>Since the server doesn’t need to be particularly complex, I decided to just use plain <a href=https://docs.rs/hyper>hyper</a> - no higher-level framework or anything. And it doesn’t need performance, so I’m only using Tokio’s current thread runtime instead of the heavier multi-threaded scheduler.</p><p>The server’s main job is to take a request path and map it to a path on the filesystem, which it does just by splitting on <code class=scode>/</code> and reconstructing a <code class=scode>PathBuf</code>. I also have some extra logic to solve problems (2) and (3) - adding <code class=scode>index.html</code> and <code class=scode>.html</code> to paths as a fallback if the requested path doesn’t exist. I guess the MIME type to serve based on file extension, which works fine for me, and also set <code class=scode>Cache-Control: no-cache</code> to avoid having the browser cache the pages.</p><p>To achieve live reloading, two things need to be coordinated. First, the server has to expose an endpoint that allows the browser to wait for a change to happen to any of the files it’s viewing - I do this via a <code class=scode>/watch</code> endpoint that accepts a list of paths to watch in its query parameters (decoded with <a href=https://docs.rs/form_urlencoded><code class=scode>form_urlencoded</code></a>) and gives back an SSE stream that sends an empty event once something happens. Internally this is implemented with a Tokio <code class=scode>broadcast</code> channel of <code class=scode>notify::Event</code>s, and a spawned task that subscribes to the channel and checks whether any of the events apply to it, sending an SSE event if so. Secondly, the client needs to produce a list of all the files it depends on and then send that in the SSE request to the server, reloading once it receives any data over that connection.</p><p>I do all that by passing in a boolean property <code class=scode>live_reload</code> to the templates, and only enable it when the server is running (this is easy since the server and build process share the same binary). The page will build up a set of dependencies in a <code class=scode>URLSearchParams</code> object then send off the request like so:</p><pre class=scode><code><span class="shtml sbasic stext">{{#if live_reload}}
			<span class="smeta shtml stag sscript sbegin"><span class="spunctuation sbegin sdefinition shtml stag">&lt;</span><span class="shtml stag sentity sname sscript">script</span></span><span class="smeta shtml stag sscript sbegin"><span class="spunctuation send sdefinition shtml stag">></span></span>
			<span class="shtml sembedded sjs ssource"><span class="sjs ssource">	<span class="stype sstorage sjs">const</span> <span class="svariable sother sjs sreadwrite">source</span> <span class="skeyword soperator sjs sassignment">=</span> <span class="smeta sjs sconstructor sinstance"><span class="skeyword soperator sjs snew sword">new</span><span class="smeta sfunction-call sjs sconstructor"> <span class="stype sjs svariable">EventSource</span><span class="smeta sgroup sjs"><span class="spunctuation ssection sgroup sjs">(</span><span class="sjs sstring stemplate"><span class="spunctuation sbegin sdefinition sstring sjs stemplate">`</span>/watch?</span><span class="smeta sjs sexpression stemplate"><span class="spunctuation sbegin sdefinition sjs stemplate-expression">${</span></span><span class="smeta sjs sexpression stemplate"><span class="sjs sexpression sembedded ssource"><span class="svariable sother sjs sreadwrite">params</span></span><span class="spunctuation send sdefinition sjs stemplate-expression">}</span></span><span class="sjs sstring stemplate"><span class="spunctuation send sdefinition sstring sjs stemplate">`</span></span></span><span class="smeta sgroup sjs"><span class="spunctuation ssection sgroup sjs">)</span></span></span></span><span class="spunctuation sterminator sjs sstatement">;</span>
				<span class="svariable sother sjs sobject">source</span><span class="spunctuation saccessor sjs">.</span><span class="smeta sfunction-call sjs smethod"><span class="svariable sfunction sjs">addEventListener</span><span class="smeta sgroup sjs"><span class="spunctuation ssection sgroup sjs">(</span><span class="sjs sstring sdouble squoted"><span class="spunctuation sbegin sdefinition sstring sjs">"</span>message<span class="spunctuation send sdefinition sstring sjs">"</span></span><span class="spunctuation sseparator scomma sjs">,</span> <span class="smeta sfunction sdeclaration sjs"><span class="spunctuation ssection sgroup sbegin sjs">(</span><span class="spunctuation ssection sgroup send sjs">)</span><span class="smeta sfunction sdeclaration sjs"> </span><span class="stype sstorage sfunction sarrow sjs">=></span></span> <span class="smeta sblock sjs"><span class="svariable sother sjs sobject">location</span><span class="spunctuation saccessor sjs">.</span><span class="smeta sfunction-call sjs smethod"><span class="svariable sfunction sjs">reload</span><span class="smeta sgroup sjs"><span class="spunctuation ssection sgroup sjs">(</span></span><span class="smeta sgroup sjs"><span class="spunctuation ssection sgroup sjs">)</span></span></span></span></span><span class="smeta sgroup sjs"><span class="spunctuation ssection sgroup sjs">)</span></span></span><span class="spunctuation sterminator sjs sstatement">;</span>
			</span></span><span class="smeta shtml stag sscript send"><span class="spunctuation sbegin sdefinition shtml stag">&lt;/</span><span class="shtml stag sentity sname sscript">script</span><span class="spunctuation send sdefinition shtml stag">></span></span>
			{{/if}}
			</span></code></pre><p>And just like that, we have live reloading. Whenever I edit one of the source files like the one I’m writing, a whole chain of automated events is set off, culminating in the reload of the page I’m viewing in-browser:</p><ol><li>The <code class=scode>notify</code> watcher sees the event and regenerates the main asset.</li><li>The main asset generates the “blog posts” asset.</li><li>The “blog posts” asset generates the asset for this blog post.</li><li>This asset compares the dates of its input and output files, and upon seeing that the input file is newer than the output file decides to regenerate itself.</li><li>The updated blog post HTML is written out to the <code class=scode>dist/</code> directory.</li><li>The <code class=scode>notify</code> watcher sees the event and passes it over to the server’s broadcast channel.</li><li>The task spawned to manage the connnection to the site receives the event from the channel, and upon checking what paths it affects decides that the web page should reload.</li><li>The task sends an SSE event to the website which it then receives.</li><li>The website reloads, sending a new request to the server and receiving the updated blog post HTML.</li></ol><h2 id=conclusion><a href=#conclusion class=anchor></a>Conclusion</h2><p>Overall, I am extremely pleased with how this whole project has turned out. I now have my own personal website, designed in exactly the way I like it able to support exactly the workflow that I like, with almost everything completely automated with the power of code.</p><p>Do I recommend it if you want to start your own website? Not really, unless you’d do this sort of programming project anyway. All in all it took about a week to set up, and I was working on it for several hours each day. I can probably imagine that using an existing static site generator is a thousand times easier and faster and produces just as good output. But it was an extremely fun project for me do so I can definitely recommend it in that sense.</p><p>If you want to check out the actual code it’s <a href=https://github.com/SabrinaJewson/sabrinajewson.github.io>on GitHub</a> and contains all the things I talked about here, as well as some more mundane stuff I left out the article for brevity. Its file structure is located into three main folders:</p><ul><li><code class=scode>builder</code>, which contains the Rust source code of the crate that builds the site and runs the server.</li><li><code class=scode>template</code>, which contains Handlebars templates, CSS, code themes and various other dynamic configuration parts related to the site.</li><li><code class=scode>src</code>, which contains the source Markdown of the posts I’ve written as well as the favicon of the website.</li></ul><p>Anyway, I really hope you enjoyed reading this post and maybe learnt something you found interesting. See you next time!</p><p class=back><a href=#>⮬ Back to top</a></p></main></body></html>